<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Geospatial Analysis with R</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs-2.20/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/lucy.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/middlebury-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="themes/class18.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Geospatial Analysis with R
]
.subtitle[
## Class 19
]

---


## Today

- Challenge
- Terrain analysis
- Interpolation, Distance
- Modeling 

---
## Challenge group work
- You are looking to compare ndvi measurements from the Arable Mark (ground sensor) and Sentinel-2, for one growing season in Zambia. 
- You start with a .csv file containing the dates and ground sensor ndvi.

```r
library(geospaar)
library(raster)
ground_df &lt;- read.csv(("../inst/extdata/chilanga_farmer/Makulu_farmer.csv"))
ground_df$date &lt;- as.Date(ground_df$date)
ggplot(ground_df) +
  geom_point(aes(x = date, y = ndvi),col = 'red') +
  theme_bw()
```

```
## Warning: Removed 175 rows containing missing values (`geom_point()`).
```

![](class19_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;

---
## Challenge group work
- You have downloaded a set of Sentinel-2 raster files for this area.
- Here we show how to import one such file.

```r
r1 &lt;- brick("../inst/extdata/chilanga_farmer/20210529T075609_20210529T082146_T35LPC.tif")
plot(r1)
```

![](class19_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;

---
## Challenge group work
- You know the coordinates of the Mark location. Here, we use that to create an `sf` object.

```r
pt &lt;- st_point(x = c(28.28576,	-15.58808)) %&gt;% st_sfc(crs = 4326) %&gt;% st_as_sf()
```

---
## Your goal
- Extract Sentinel-2 NDVI values, using a 20m buffer around `pt`. 
- Add a column "S2_ndvi". to `ground_df`. Dates with no S2 observation should have an `NA` value.
- Use `ggplot` to plot a time-series of the pod NDVI (red), and S2 ndvi (blue)
- Calculate the 'delta' (offset) between pod and S2 ndvi. Plot this time-series as well. 

---
## Create buffer, ndvi image


```r
pt_buffer &lt;- pt %&gt;% st_transform(crs = crs(r1)) %&gt;% st_buffer(20)
ndvi &lt;- (r1[['B8']] - r1[['B4']])/(r1[['B8']] + r1[['B4']])
plot(ndvi)
plot(pt_buffer, add = T)
```

![](class19_files/figure-html/unnamed-chunk-4-1.png)&lt;!-- --&gt;

---
## Extract value, date


```r
value &lt;- raster::extract(ndvi, pt_buffer, fun = mean) %&gt;% as.numeric()
img_date &lt;- "20210529T075609_20210529T082146_T35LPC.tif" %&gt;% 
  substr( 1, 8) %&gt;% 
  as.Date(., format = "%Y%m%d")
print(value)
```

```
## [1] 0.4463066
```

```r
print(img_date)
```

```
## [1] "2021-05-29"
```

---
## Add value to data frame

```r
row_index &lt;- which(ground_df$date == img_date)

ground_df$S2_ndvi &lt;- NA ## set up blank column

ground_df[row_index, "S2_ndvi"] &lt;- value
#ground_df
```

---
## Use `for` to add all values

```r
image_files &lt;- list.files("../inst/extdata/chilanga_farmer/", pattern = ".tif")

for (name in image_files){
  print(name)
  r &lt;- brick(paste0("../inst/extdata/chilanga_farmer/", name))
  ndvi &lt;- (r[['B8']] - r[['B4']])/(r[['B8']] + r[['B4']])
  value &lt;- raster::extract(ndvi, pt_buffer, fun = mean) %&gt;% as.numeric()
  img_date &lt;- name %&gt;% substr( 1, 8) %&gt;% as.Date(., format = "%Y%m%d")
  row_index &lt;- which(ground_df$date == img_date)
  ground_df[row_index, "S2_ndvi"] &lt;- value
}
```

```
## [1] "20201105T080121_20201105T081923_T35LPC.tif"
## [1] "20201110T080149_20201110T082146_T35LPC.tif"
## [1] "20201115T080211_20201115T082106_T35LPC.tif"
## [1] "20201120T080229_20201120T082151_T35LPC.tif"
## [1] "20201125T080251_20201125T082116_T35LPC.tif"
## [1] "20210104T080331_20210104T082153_T35LPC.tif"
## [1] "20210124T080221_20210124T082103_T35LPC.tif"
## [1] "20210223T075921_20210223T082102_T35LPC.tif"
## [1] "20210305T075811_20210305T082103_T35LPC.tif"
## [1] "20210310T075739_20210310T082145_T35LPC.tif"
## [1] "20210320T075629_20210320T082146_T35LPC.tif"
## [1] "20210325T075611_20210325T082101_T35LPC.tif"
## [1] "20210330T075609_20210330T082144_T35LPC.tif"
## [1] "20210404T075611_20210404T082059_T35LPC.tif"
## [1] "20210409T075609_20210409T082143_T35LPC.tif"
## [1] "20210414T075601_20210414T082057_T35LPC.tif"
## [1] "20210419T075609_20210419T082140_T35LPC.tif"
## [1] "20210424T075611_20210424T082059_T35LPC.tif"
## [1] "20210429T075609_20210429T082141_T35LPC.tif"
## [1] "20210504T075611_20210504T082101_T35LPC.tif"
## [1] "20210509T075609_20210509T082144_T35LPC.tif"
## [1] "20210514T075611_20210514T082103_T35LPC.tif"
## [1] "20210519T075609_20210519T082210_T35LPC.tif"
## [1] "20210524T075611_20210524T082103_T35LPC.tif"
## [1] "20210529T075609_20210529T082146_T35LPC.tif"
```

```r
#View(ground_df)
```

---
## Mean Difference


```r
ground_df$ndvi_diff &lt;- ground_df$ndvi - ground_df$S2_ndvi
mean(ground_df$ndvi_diff, na.rm = T)
```

```
## [1] 0.0430526
```

- plot

```r
ggplot(ground_df) +
  geom_point(aes(x = date, y = ndvi), col = 'red') +
  geom_point(aes(x = date, y = S2_ndvi), col = 'blue') +
  theme_bw()
```

```
## Warning: Removed 175 rows containing missing values (`geom_point()`).
```

```
## Warning: Removed 312 rows containing missing values (`geom_point()`).
```

![](class19_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;

---
## Exercises

- Create a dummy raster (sampling from 1:100) using district 49 for extent and res of 0.1
- Reproject to Albers
- Disaggregate to 0.02 degrees (bilinear and NGB)
- Calculate the sum of rainfall from `chirps`
- Identify all areas of total rainfall &gt; 10 mm. Set these cells to 1 and other cells to 0.
- Calculate the mean rainfall in Zambia for the 15th day in `chirps`




---
## Exercise answers
- Create a dummy raster (sampling from 1:100) using district 49 for extent and res of 0.1


```r
r &lt;- raster(extent(districts[49, ]), res = 0.1, crs = 4326)
set.seed(1)
values(r) &lt;- sample(1:100, size = ncell(r), replace = TRUE)
plot_noaxes(r)
plot(districts[49, ]$geometry, add = TRUE)
```

- Reproject to Albers

```r
ralb &lt;- projectRaster(r, crs = "ESRI:102022", 
                      res = c(13000, 11000), method = "ngb")
ralb &lt;- projectRaster(r, crs = "ESRI:102022", res = c(13000, 13000))
par(mfrow = c(1, 2))
plot_noaxes(r)
plot_noaxes(ralb)
r; ralb
```
- Disaggregate to 0.02 degrees

```r
r02 &lt;- disaggregate(r, fact = 5)
r02b &lt;- disaggregate(r, fact = 5, method = "bilinear")
plot(stack(r02, r02b))
```

---

- Calculate the sum of rainfall from `chirps`

```r
raintot &lt;- calc(chirps, sum)
raintot2 &lt;- calc(chirpsz, sum)
plot(stack(raintot, raintot2))
```
- Identify all areas of total rainfall &gt; 10 mm

```r
rain10 &lt;- raintot2 &gt; 10
rain50 &lt;- raintot2 &gt; 50
rain100 &lt;- raintot2 &gt; 100
rains &lt;- stack(rain10, rain50, rain100)
names(rains) &lt;- c("Rain_gt_10mm", "Rain_gt_50mm", "Rain_gt_100mm")
plot(rains, main = c("Rain &gt; 10mm", "Rain &gt; 50mm", "Rain &gt; 100mm"))
```
- Calculate the mean rainfall in Zambia for the 15th day in `chirps`

```r
rainmean &lt;- calc(chirpsz, mean)
cellStats(chirpsz[[15]], mean)
hist(chirpsz[[15]], breaks = seq(0, 12, 2))
freq(chirpsz[[15]])
plot(rainmean)
# plot(rainmean)
```



---
## Today

- terrain analysis
- distance
- modeling

---
## Simple terrain analysis
- requires DEM as input (use getData)

```r
dem &lt;- getData(name = "alt", country = "ZMB", path = tempdir())
```

```
## Warning in getData(name = "alt", country = "ZMB", path = tempdir()): getData will be removed in a future version of raster
## . Please use the geodata package instead
```

```r
roads &lt;- read_sf(system.file("extdata/roads.shp", package = "geospaar"))
districts &lt;- st_read(system.file("extdata/districts.shp", package = "geospaar"))
```

```
## Reading layer `districts' from data source 
##   `C:\Users\micha\AppData\Local\R\win-library\4.2\geospaar\extdata\districts.shp' 
##   using driver `ESRI Shapefile'
## Simple feature collection with 72 features and 1 field
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 21.99978 ymin: -18.0751 xmax: 33.6875 ymax: -8.226213
## Geodetic CRS:  GCS_unknown
```

```r
## reproject DEM to Albers
zamr &lt;- raster(x = extent(districts), crs = crs(districts), res = res(dem))
values(zamr) &lt;- 1:ncell(zamr)
zamr_alb &lt;- projectRaster(from = zamr, res = 1000, crs = crs(roads), 
                          method = "ngb")
demalb &lt;- projectRaster(from = dem, to = zamr_alb)  # default is bilinear
plot(demalb)
```

![](class19_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;

---
## Simple terrain analysis

```r
vars &lt;- c("slope", "aspect", "flowdir", "tri")
terrvars &lt;- stack(lapply(1:length(vars), function(x) {
  tv &lt;- terrain(x = demalb, opt = vars[x], unit = "degrees")
}))
names(terrvars) &lt;- vars

plot_noaxes(terrvars)
```

![](class19_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;


---
## Terrain analysis with zonal statistics


```r
districts &lt;- districts %&gt;% mutate(ID = 1:nrow(.))
distsr &lt;- districts %&gt;% rasterize(x = ., y = raintot, field = "ID") %&gt;% print()
plot(distsr)

# Download DEM
data(dem)
# dem &lt;- getData(name = "alt", country = "ZMB", path = tempdir())
dem &lt;- getData(name = "worldclim", var = 'tmean', res = 2.5,  path = tempdir())

# calculate slope
slope &lt;- terrain(x = dem, opt = 'slope', unit = 'degrees')
plot(slope)

# calculate mean by district
distsr_rs &lt;- resample(x = distsr, y = slope, method = "ngb")
zoneslope &lt;- zonal(x = slope, z = distsr_rs, fun = "mean")
hist(zoneslope[, 2])
zoneelevation &lt;- zonal(x = dem, z = distsr_rs, fun = "mean")
hist(zoneelevation[, 2])
```
---


```r
# map zonal statistics
distr_slopezone &lt;- zoneslope %&gt;% data.frame %&gt;%  
  subs(x = distsr_rs, y = ., by = "zone")
distr_elezone &lt;- zoneelevation %&gt;% data.frame %&gt;% 
  subs(x = distsr_rs, y = ., by = "zone")

# plot
l &lt;- list(distr_elezone, distr_slopezone)
titles &lt;- c("Elevation", "Slope")
par(mfrow = c(1, 2))
for(i in 1:length(l)) {
  plot_noaxes(l[[i]], main = titles[i])
}
```

---
## Climate data summaries and zonal stats


```r
# rainfall &lt;- getData(name = "worldclim", res = 10, var = 'tmax',
#                     path = tempdir())
# dt &lt;- as.Date(gsub("Y", "", names(chirpsz)), format = "%y%j")
dt &lt;- lubridate::parse_date_time(gsub("Y", "", names(chirpsz)), orders = "yj")
wk &lt;- lubridate::week(dt)
weekly_rainfall &lt;- lapply(unique(wk), function(x) {
  which(wk == x)
  calc(chirpsz[[which(wk == x)]], sum)
}) %&gt;% stack(.)
names(weekly_rainfall) &lt;- paste0("wk", unique(wk))

rflim &lt;- range(cellStats(weekly_rainfall, range))
plot(stack(weekly_rainfall), zlim = rflim)
```

---
## Distance
- plot distance from points
- points must be in same projection as model raster

```r
set.seed(1)
randsamp &lt;- sampleRandom(raintotalb, size = 10, xy = TRUE) %&gt;% 
  as_tibble %&gt;%  
  st_as_sf(coords = c("x", "y")) 
st_crs(randsamp) &lt;- crs(raintotalb)
# #2
ptdistr &lt;- distanceFromPoints(object = raintotalb, xy = as_Spatial(randsamp))
ptdistrmsk &lt;- mask(ptdistr, raintotalb)
plot(ptdistrmsk)
```

![](class19_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;



---
## Interpolation
- You have values at certain sample points, but need values at all points in raster
- 

```r
## Simple terrain analysis
library(gstat)
```

```
## Warning: package 'gstat' was built under R version 4.2.3
```

```r
# #1
raintotalb &lt;- projectRaster(from = raintot, res = 5000, crs = crs(roads))
names(raintotalb) &lt;- "rain"
r &lt;- raster(extent(raintotalb), res = res(raintotalb), 
            crs = crs(raintotalb), vals = 1)

# #2
set.seed(1)
rainsamp &lt;- sampleRandom(raintotalb, size = 1000, xy = TRUE)
rainsamp &lt;- as.data.frame(rainsamp)
# head(rainsamp)

# #3
invdist &lt;- gstat(id = "rain", formula = rain ~ 1, locations = ~x + y, 
                 data = rainsamp)
invdistr &lt;- interpolate(object = r, model = invdist)
```

```
## [inverse distance weighted interpolation]
```

```r
invdistrmsk &lt;- mask(x = invdistr, mask = raintotalb)
```


---
- kriging

```r
coordinates(rainsamp) &lt;- ~x + y  # a
crs(rainsamp) &lt;- crs(roads)  # b
v &lt;- variogram(object = rain ~ 1, data = rainsamp)  # c
m &lt;- fit.variogram(object = v, model = vgm("Sph"))  # d
m
```

```
##   model    psill    range
## 1   Nug  14.1009      0.0
## 2   Sph 380.2139 457427.7
```

```r
#&gt; model    psill    range
#&gt; 1   Nug  14.1009      0.0
#&gt; 2   Sph 380.2139 457427.7

plot(variogramLine(m, max(v[, 2])), type = "l")  # e
points(v[, 2:3], pch = 20)  # f
legend("bottomright", legend = c("variogram fit", "variogram"), 
       lty = c(1, NA), pch = c(NA, 20), bty = "n") # g
```

![](class19_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;

```r
ordkrig &lt;- gstat(id = "rain", formula = rain ~ 1, data = rainsamp, model= m)
ordkrigr &lt;- interpolate(object = r, model = ordkrig)
```

```
## [using ordinary kriging]
```

```r
ordkrigrmsk &lt;- mask(x = ordkrigr, mask = raintotalb)
```

---
## plot interpolations

```r
raininterp &lt;- stack(raintotalb, invdistrmsk, ordkrigrmsk)
titles &lt;- c("Actual rain", "IDW rain", "Kriged rain")
par(mfrow = c(2, 2), mar = c(0, 0, 1, 0))
plot(rainsamp, pch = 20, cex = 0.5)
for(i in 1:3) plot_noaxes(raininterp[[i]], main = titles[i])
```

![](class19_files/figure-html/unnamed-chunk-24-1.png)&lt;!-- --&gt;





---
## Regression modeling
- we will predict precipitation from 3 variables
  - X (longitude)
  - Y (latitude)
  - elevation
- First sample points and create table

```r
data(zamprec)
zamprecalb &lt;- projectRaster(from = zamprec, to = raintotalb)
names(zamprecalb) &lt;- "rain"
elev &lt;- resample(aggregate(x = demalb, fact = 5), y = raintotalb)

# #2
set.seed(1)
pts &lt;- sampleRandom(x = zamprecalb, size = 500, sp = TRUE) %&gt;% st_as_sf
pts &lt;- pts %&gt;% mutate(elev = raster::extract(x = elev, y = .)) 
pts_dat &lt;- bind_cols(
  pts %&gt;% data.frame %&gt;% dplyr::select(-geometry) %&gt;% as_tibble, 
  st_coordinates(pts) %&gt;% as_tibble
) %&gt;% drop_na
head(pts_dat)
```

```
## # A tibble: 6 Ã— 4
##    rain  elev        X         Y
##   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 1155. 1214.  592597. -1409906.
## 2 1226. 1306.  102597. -1509906.
## 3 1029. 1116.   67597. -1654906.
## 4  783. 1091.  -47403. -1949906.
## 5 1157. 1247.  387597. -1339906.
## 6  747. 1016. -187403. -1939906.
```

---
## Create linear model

```r
rain_lm &lt;- lm(rain ~ X + Y + elev, data = pts_dat)
summary(rain_lm)
```

```
## 
## Call:
## lm(formula = rain ~ X + Y + elev, data = pts_dat)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -436.69  -54.20   -6.25   59.44  292.20 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.809e+03  6.135e+01   29.49   &lt;2e-16 ***
## X           -1.806e-04  1.750e-05  -10.32   &lt;2e-16 ***
## Y            6.356e-04  2.433e-05   26.12   &lt;2e-16 ***
## elev         2.465e-01  2.457e-02   10.03   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 98.32 on 495 degrees of freedom
## Multiple R-squared:  0.7579,	Adjusted R-squared:  0.7564 
## F-statistic: 516.5 on 3 and 495 DF,  p-value: &lt; 2.2e-16
```

---
## Create raster layers for each  variable
- We already have layers for precip and elevation. 
- Need layers for long and lat.

```r
xs &lt;- xFromCell(object = raintotalb, cell = 1:ncell(raintotalb))
ys &lt;- yFromCell(object = raintotalb, cell = 1:ncell(raintotalb))
X &lt;- Y &lt;- raintotalb
values(X) &lt;- xs
values(Y) &lt;- ys
predst &lt;- stack(X, Y, elev)
names(predst) &lt;- c("X", "Y", "elev")
plot(predst)
```

![](class19_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;

---
## Apply model and plot

```r
## apply model to raster stack
predrainr &lt;- predict(object = predst, model = rain_lm)

## plot
s &lt;- stack(zamprecalb, predrainr, (predrainr - zamprecalb) / zamprecalb * 100)
mae &lt;- round(cellStats(abs(zamprecalb - predrainr), mean), 1)  

pnames &lt;- c("'Observed' Rainfall", "Predicted Rainfall", "% Difference")
par(mfrow = c(1, 3), mar = c(0, 0, 1, 4))
for(i in 1:3) {
  plot_noaxes(s[[i]], main = pnames[i])
  if(i %in% 1:2) {
    pts %&gt;% st_geometry %&gt;% 
      plot(pch = 20, cex = 0.2, col = "grey70", add = TRUE)
  } else {
    mtext(side = 1, line = -3, cex = 0.8, 
          text = paste("Mean abs err =", mae, "mm"))
  }
}
```

![](class19_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;



---
## HW
- HW 5 due Sun 4/9








    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
